HOW TO SET COMPUTATIONAL PARAMETERS

- For the steady-state and calibration is better to keep these looser parameters

tolV    = 1d-6
tol_ge  = 1e-6 (all three r, tau_p and hsv_0)
na      = 600
a_space = 3.5d0
I noticed that the code is more robust with a_space=5d0 but unfortunately the plots for occpol 
look better with a_space = 3.5d0 

- For the experiments that require varying tau_h, need to set tighter params o/w we get squiggles
  in the plots 

tolV    = 1d-7
tol_ge  = 1e-6 for tau_p and hsv_0, 1d-7 for r
na      = 800
a_space = 5d0
nx_maxnonconvex = 150


*********************************************************************
Table of contents:
1. No avoidance experiments (see document Memo_2023_09_13)
2. Re-Calibration of the counterfactual model CF2
3. Pre-computing value from consumption
4. Comparative-statics (compstat)
5. Welfare comparison with transition (comptran)
6. Model validation: compare tau_h = 0.5 to tau_h=0.28
*********************************************************************


*********************************************************************
1. No avoidance experiments (see document Memo_2023_09_13)

STEP 1. SOLVE MODEL AND SAVE RESULTS
- Benchmark 
Set following flags 
file_params  = "estim_params_benchmark.txt"
cf_avoidance = 0
cf_occpol    = 0
do_run       = 0
do_benchmark = .true.
do_GE        = 1  ! GE interest rate, social security budget tau_p
dir_bench = trim(savedir)//trim("ss_bench")//trim(slash)
Output files saved in folder ss_bench/.

- Experiment 1: No income shifting. ES goes away and for EC we fix phi=0
Check that share ES is zero. We can do this experiment with and w/out 
fiscal neutrality 

Set following flags 
file_params  = "estim_params_benchmark.txt"
cf_avoidance = 1
cf_occpol    = 0
do_run       = 0
do_benchmark = .false.
do_GE        = 1 w/out fiscal neutr, 2 with fiscal neutr 
do_fix_ss_cap = 0 (ss_cap is endogenous)

Output files saved in folder exp1_fn/ when do_GE = 2.


- Experiment 2: All entre pay income and payroll tax. ES goes away and for EC we impose phi=1
Check that share ES is zero
Check that corporate and dividend taxes are exactly zero

Set following flags 
file_params  = "estim_params_benchmark.txt"
cf_avoidance = 2
cf_occpol    = 0
do_run       = 0
do_benchmark = .false.
do_GE        = 1 w/out fiscal neutr, 2 with fiscal neutr 
do_fix_ss_cap = 0 (ss_cap is endogenous)

Output files saved in folder exp2_fn/ when do_GE = 2.

- Experiment 3 No income shifting. ES goes away and for EC we fix phi=0
Check that share ES is zero. We can do this experiment with and w/out 
fiscal neutrality. Occpol is set to benchmark

Set following flags 
file_params  = "estim_params_benchmark.txt"
cf_avoidance = 1
cf_occpol    = 1
do_run       = 0
do_benchmark = .false.
do_GE        = 1 w/out fiscal neutr, 2 with fiscal neutr 
dir_bench = trim(savedir)//trim("ss_bench")//trim(slash)
do_fix_ss_cap = 0 (ss_cap is endogenous)

If cf_occpol    = 1, occpol_bench is read from occpol in dir_bench
Output files saved in folder exp3_fn/ when do_GE = 2.

- Experiment 4 All entre pay income and payroll tax. ES goes away and for EC we impose phi=1
Occpol is set to benchmark

Set following flags 
file_params  = "estim_params_benchmark.txt"
cf_avoidance = 2
cf_occpol    = 1
do_run       = 0
do_benchmark = .false.
dir_bench = trim(savedir)//trim("ss_bench")//trim(slash)
do_GE        = 1 w/out fiscal neutr, 2 with fiscal neutr 
do_fix_ss_cap = 0 (ss_cap is endogenous)

If cf_occpol    = 1, occpol_bench is read from occpol in dir_bench
Output files saved in folder exp4_fn/ when do_GE = 2.

- Experiment 5 All entre pay income and payroll tax. ES goes away and for EC we impose phi=1
We impose fiscal neutrality but fix interest rate r

Set following flags 
file_params  = "estim_params_benchmark.txt"
cf_avoidance = 2
cf_occpol    = 0
do_run       = 0
do_benchmark = .false.
dir_bench = trim(savedir)//trim("ss_bench")//trim(slash)
do_GE        = 3 with fiscal neutr but fixed r
do_fix_ss_cap = 0 (ss_cap is endogenous)

Output files saved in folder exp5_fn/

STEP 2. WELFARE COMPUTATION

Set following flags 
do_run       = 5
dir_bench = trim(savedir)//trim("ss_bench")//trim(slash)

Output files (cev...) saved in folders exp1_fn - exp5_fn.

***********************************************************************************
2. Re-Calibration of the counterfactual model CF2

Purpose: We recalibrate the CF2 (no avoidance) model. The exercises of varying tau_h in the CF2 model is based on the recalibrated model.

Set following flags 

cf_avoidance = 2
cf_occpol    = 0
do_run       = 0
do_benchmark = .true.
do_GE        = 1
dir_bench = trim(savedir)//trim("CF2_bench")//trim(slash)
file_params  = "estim_params_CF2.txt"

The parameters for the recalibrated CF2 model are saved in input/estim_params_CF2.txt.

**************************************************************
3. Pre-computing value from consumption

Purpose: We compute the value of consumption, called valc, for the benchmark with tax avoidance and for the benchmark with CF2 (no avoidance)
Notes: This should be done before running anything that requires computing CEV's, but after we are done calibrating the benchmark or CF2 mode.

do_run          = 0
cf_avoidance    = 0 tax avoidance, 2 no tax avoidance
cf_occpol       = 0
do_compute_valc = 1
do_GE           = 1 without fiscal neutrality;
do_benchmark    = .true.

file_params = "estim_params_benchmark.txt" for tax avoidance, or
              "estim_params_CF2.txt" for no tax avoidance
dir_bench   = trim(savedir)//trim("ss_bench")//trim(slash), or  
              trim(savedir)//trim("CF2_bench")//trim(slash)

valc is saved in dir_bench and will be read accordingly


***********************************************************************************

4. Comparative-statics (compstat)

Purpose: varying tau_h without transition and with/without fiscal neutrality. Without fiscal neutrality, we plot the laffer curve. With fiscal neutrality, we plot CEV.
Notes: This should be done after recalibration of the CF2 model. If we choose fiscal neutrality, we should do the pre-computation of the value from consumption first. 

do_run       = 2
cf_avoidance = 0 or 2 (0 = benchmark model with tax avoidance; 2 = CF2 model with no avoidance)
cf_occpol    = 0
do_GE        = 1 or 2 (1 = without fiscal neutrality, 2 = with fiscal neutrality)
do_CEV_decomp = 0 or 1 (this is only relevant for do_GE=2. 0 = only aggregate CEV; 1 = aggregate CEV and decomposition into aggregate and distributional components (very slow!))
n_tau_h      = No. of points for tau_h grid
do_write     = 1 (1=write results to external files)
do_fix_ss_cap = 0 (ss_cap is fixed at the corresponding benchmark level)
do_fix_pen    = 0 or 1 (if 1, pen is read from the benchmark folder)
do_benchmark = .false.

file_params  = "estim_params_benchmark.txt" if benchmark model; 
                "estim_params_CF2.txt" if CF2 model.
dir_bench    = trim(savedir)//trim("ss_bench")//trim(slash) if benchmark model;
                trim(savedir)//trim("CF2_bench")//trim(slash) if CF2 model.

Output folder: 
  - if do_GE = 1 and cf_avoidance = 0: compstat
  - if do_GE = 1 and cf_avoidance = 2: compstat_CF2
  - if do_GE = 2 and cf_avoidance = 0: compstat_fn
  - if do_GE = 2 and cf_avoidance = 2: compstat_CF2_fn

***********************************************************************************
5. Welfare comparison with transition (comptran)

Purpose: Optimal tax exercise, varying tau_h with transition and with fiscal neutrality.

***STEP 1: Loop over tau_h

do_run       = 3
cf_avoidance = 0 or 2 (0 = benchmark model with tax avoidance; 2 = CF2 model with no avoidance)
cf_occpol    = 0
do_GE        = 2 (with fiscal neutrality)
do_CEV_decomp = 0 or 1 (0 = only aggregate CEV; 1 = aggregate CEV and decomposition into aggregate and distributional components (very slow!) If 1, make sure that valc_r and valc_y are saved in the benchmark folder.)
n_tau_h      = No. of points for tau_h grid
do_write     = 1 (1=write results to external files)
do_fix_ss_cap = 0 (ss_cap is fixed at the corresponding benchmark level)
do_benchmark = .false.

file_params  = "estim_params_benchmark.txt" if benchmark model; 
                "estim_params_CF2.txt" if CF2 model.
dir_bench    = trim(savedir)//trim("ss_bench")//trim(slash) if benchmark model;
                trim(savedir)//trim("CF2_bench")//trim(slash) if CF2 model.

Output folder: 
  - if do_GE = 2 and cf_avoidance = 0: comptran_fn
  - if do_GE = 2 and cf_avoidance = 2: comptran_CF2_fn


*** STEP 2: transition to the optimal tau_h
Purpose: After step 1 (Loop over tau_h), we compute the transition to the optimal tau_h and save transition path, CEV distribution etc.

do_run       = 4
cf_avoidance = 0 or 2 (0 = benchmark model with tax avoidance; 2 = CF2 model with no avoidance)
cf_occpol    = 0
do_GE        = 2 (with fiscal neutrality)
n_tau_h      = No. of points for tau_h grid
do_write     = 1 (1=write results to external files)
do_fix_ss_cap = 0 (ss_cap is fixed at the corresponding benchmark level)
do_benchmark = .false.

file_params  = "estim_params_benchmark.txt" if benchmark model; 
                "estim_params_CF2.txt" if CF2 model.
dir_bench    = trim(savedir)//trim("ss_bench")//trim(slash) if benchmark model;
                trim(savedir)//trim("CF2_bench")//trim(slash) if CF2 model.

Output folder: 
  - if do_GE = 2 and cf_avoidance = 0: comptran_fn
  - if do_GE = 2 and cf_avoidance = 2: comptran_CF2_fn

*********************************************************************
6. Model validation: compare tau_h = 0.5 to tau_h=0.28
Purpose: for model validation, we compare steady states with fiscal neutrality for the two levels of top tax rate.

do_run       = 1
cf_avoidance = 0
cf_occpol    = 0
do_GE        = 2 (with fiscal neutrality)
n_tau_h      = 3
do_fix_ss_cap = 0 
do_benchmark = .false.


file_params  = "estim_params_benchmark.txt"
dir_bench    = trim(savedir)//trim("ss_bench")//trim(slash)

Output folder: validation


**************************************************************
Code improvements

- fun_prices_KN
- Update mod_numerical with discretize_AR
- Remove toolbox from makefile
    - mod_targets line 7
- Remove mod_nelder_meade or similar from makefile

===============================================================
VARIABLE              DIMENSION            DESCRIPTION
===============================================================

TO BE UPDATED !!!! Haomin!!!! 

a_grid                (na)                 Grid for assets
eps_grid              (neps)               Grid for shock epsilon
theta_grid            (ntheta)             Grid for shock theta_grid
P_eps                 (neps,neps)          Markov chain for epsilon
P_theta               (ntheta,ntheta)      Markov chain for theta
prob_eps              (neps)               Invariant distribution for epsilon
prob_theta            (ntheta)             Invariant distribution for theta
k_grid                (nk)                 Grid for capital (NOT USED)
l_grid                (nl)                 Grid for hours worked (labor supply)

mu                    (na,neps,ntheta,nz)   Stationary distribution over (a,eps,theta,z)
apol                  (na,neps,ntheta,nz)   Policy function for a', value
cpol                  (na,neps,ntheta,nz)   Policy function for consumption
lpol_ind              (na,neps,ntheta)      Policy function for hours worked (value), index
lpol                  (na,neps,ntheta)      Policy function for hours worked (value), value
occpol                (na,neps,ntheta)      Policy function for occupational choice 
kpol                  (na,ntheta,nz)        Policy function for k, value,                     only if z={EP=2,ES=3,EC=4}
nbarpol               (na,ntheta,nz)        Policy function for total labor input (nbar=l+n), only if z={EP=2,ES=3,EC=4}
npol                  (na,neps,ntheta)      Policy function for hired labor
phipol_val            (na,ntheta,nz)        Policy function for phi (wage fraction), value,   only if z={ES=3,EC=4}

V0                    (na,neps,ntheta)      Value function young (a,eps,theta)
VR_0                  (na,neps,ntheta)      Value function retirees (a,eps,theta)

============= STATE SPACE OF THE MODEL ==========================
a:      asset holdings
eps:    workers ability, exogenous shock
theta:  entrepreneurs ability, exogenous shock
z:      occupation/legal form status plus retired
==================================================================
na:     # grid points assets
nl:     # grid points labor supply
neps:   # grid points eps
ntheta: # grid points theta
nz:     # 5 states (W,EP,ES,EC,R)
nphi:   # grid points for phi (wage fraction) (NOT USED)
nk:     # grid points for k (NOT USED)
==================================================================


